# angularjs-play

## Introduction
The purpose of this project was to create an application using using AngularJS, RequireJS and the PlayFramework that I can use as a baseline 
project for any future web applications that I write. There are templates from Typesafe and others [1,2] which I used as a starting point. 
However, I wanted to create a project which solved/implemented all the things which I need when developing an application i.e.

* Dependency injection using Guice
* Unit testing of AngularJS controllers/services/directives
* Unit testing of Play controllers using Scalatest/Mockito
* End to end testing using Scalatest/Scalatest Plus/Selenium
* Use Slick
* Write integration tests for Slick using DbUnit
* Implement authentication and authorization for Play
* Basic user/role management screens
* AngularJS form validation
* Localization
* Paging of tables in AngularJS
* Use a number of commonly required ui components found in a typical application

Currently using AngularJS 1.2. Will move to 1.3 once angular-ui-bootstrap supports it.

## Installation and Setup

### Installation
1. Install Play 2.3.X: https://www.playframework.com/download
2. Install NodeJS: https://nodejs.org/
3. Install ScalaIDE 4.0: http://scala-ide.org/
4. Install PostgreSQL (http://www.postgresql.org/) or have access to 9.X database
     
### Setup
#### Database
Need to create 2 databases - 1 for the application and other for integration tests. Typically, you would run the following:

```
create user myapp with password 'myapp';
create tablespace myapptb owner myapp location '/<some path>/postgres/myapp';
create database myapp owner=myapp tablespace=myapptb;
create database myapp_test owner=myapp tablespace=myapptb;
```

Or use pgAdmin to create user and databases.

1. Run the scripts database/schema.sql on both the myapp and myapp_test databases
2. On myapp database, run database/sample_data.sql

Note these need to be run as myapp user.

#### Play
Edit the activator start script and include

```
set SBT_OPTS="-Dsbt.jse.engineType=Node" (Windows)
SBT_OPTS="-Dsbt.jse.engineType=Node" (Linux/Mac)  
```

At the play prompt, type:

eclipse

Then import the project into ScalaIDE.

Run the application with command 'run' and open browser to http://localhost:9000. Login with simon@email.com/password.

## Testing
### Karma/Jasmine testing
These are located in test/unit. Assuming you have got NodeJS installed, run with:

npm install -g grunt-cli
npm install
grunt karma:dist

When writing tests, I found the following useful:
http://karma-runner.github.io/0.12/index.html 
http://jasmine.github.io/
http://quickleft.com/blog/angularjs-unit-testing-for-real-though
http://andyshora.com/unit-testing-best-practices-angularjs.html
http://www.tuesdaydeveloper.com/2013/06/angularjs-testing-with-karma-and-jasmine/
http://stephenjamescode.blogspot.com.au/2014/05/lab-beginners-guide-to-starting-new-web.html
http://stackoverflow.com/questions/23689671/karma-jasmine-with-angular-requirejs
http://www.benlesh.com/2013/06/angular-js-unit-testing-services.html
http://angular-tips.com/blog/2014/06/introduction-to-unit-test-services/

### Play Controller Testing
These are located under test/controllers

UsersTest is probably the most complete. Use Mockito to mock out the injected interfaces and avoid having to access the db.

These tests are written with specs2 (https://www.playframework.com/documentation/2.3.x/ScalaTestingWithSpecs2)

### Integration Testing
For may Java projects I have been involved with, I have used DbUnit to test any SQL/DAO code. I think it is important because it is 
easy for someone to change a query and not realise that it has broken some other code. Or if there is a schema change and the SQL
hasn't been updated.

But I have found that the data set formats provided by DbUnit are not to my liking. Excel spreadsheet datasets are unwieldy and
suck when it comes to storing date-time values. And wasn't too excited by the XML format either. So my choice of dataset format has been
JSON and I had been using [3].

The other down side of DbUnit tests are that they are incredibly slow. The reason for the slowness is because it needs to figure out the
truncate and insert order. The solution has been to include the insert order with the dataset and avoid this lengthly operation.

So starting with [3] and converting it to Scala (using Play JSON API), I wrote integration.dbunit.JSONDataSet.scala. The insert/truncate
order is stored in the file test/integration/insertSequence.json. This is generated by running integration.dbuniy.GenerateDatabaseInsertOrder.scala.
 
All integration tests use the trait integration.dbunit.AbstractIntegrationTest.scala and setup the database before running the test e.g.

```
  var hasInitialisedDatabase = false
   
  before {
     if (!hasInitialisedDatabase) {
       setUpBeforeClass("test/integration/usersDataset.json")
       hasInitialisedDatabase = true
     }
  }
```       

### End to end Testing
These are located under test/e2e. 

End to end testing is the final piece of the unit test puzzle which I needed to solve. AngularJS e2e testing is typically done with Protractor, 
which is still possible. However, I wanted an e2e test with the Play application. So you need to use Scalatest/Scalatest Plus. Because Guice
is used, this works out neatly. Service traits can be mocked and the controller methods get an additional test coverage. 

Need to install Chrome driver: https://code.google.com/p/selenium/wiki/ChromeDriver

From the play prompt, compile using test:compile and run with test.

When running tests from ScalaIDE, found that I need to compile from the play command line.

## Authorization
I initially looked Deadbolt and started using. In the end I rolled my own solution (based on Deadbolt). See controllers/Security.scala
for details and security package.

## Form Validation
There have been a few form validation modules written (http://ngmodules.org/) which I could of used. Although a bit clumsy, I wrote a solution
which suited my requirement - to display a popover whenever there is an invalid field. I have combined several directives I found with my own.
See app/assets/javascripts/common/directives/validate.js for details and acknowledgments. The unit test UiValidateDirectiveSpec.js illustrates
how to use the directive.  

## TODO
* Run karma tests as part of the build
* Code coverage reports 

## References
[1] http://typesafe.com/activator/template/play-angular-require-seed

[2] https://github.com/juanignaciosl/wedding-tables-planner-web

[3] http://danhaywood.com/2011/12/20/db-unit-testing-with-dbunit-json-hsqldb-and-junit-rules/
