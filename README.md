# angularjs-play

## Introduction
Demo project using AngularJS, RequireJS and the PlayFramework. Uses/solves the following:

* Dependency injection (using Guice)
* Unit testing of AngularJS controllers/services/directives
* Unit testing of Play controllers using Scalatest/Mockito
* End to end testing using Scalatest/Scalatest Plus/Selenium
* Use Slick
* Write integration tests for Slick using DbUnit
* Implement authentication and authorization for Play
* Basic user/role management screens
* AngularJS form validation
* Localization
* Demonstration of common ui components such as dialogs, table paging, filtering, etc

## Installation and Setup

### Installation
1. Install Play:  https://www.playframework.com/download
2. Install NodeJS: https://nodejs.org/
3. Install ScalaIDE: http://scala-ide.org/
4. Install PostgreSQL (http://www.postgresql.org/) or have access to 9.X database
     
### Setup
#### Database
Need to create 2 databases - one for the application and another for integration tests. Typically, you would run the following:

```
create user myapp with password 'myapp';
create tablespace myapptb owner myapp location '/<some path>/postgres/myapp';
create database myapp owner=myapp tablespace=myapptb;
create database myapp_test owner=myapp tablespace=myapptb;
```

Or use pgAdmin to create user and databases.

1. Run the scripts database/schema.sql on both the myapp and myapp_test databases
2. On myapp database, run database/sample_data.sql

Note these need to be run as myapp user.

#### Play
Edit the activator start script and include

```
set SBT_OPTS="-Dsbt.jse.engineType=Node" (Windows)
SBT_OPTS="-Dsbt.jse.engineType=Node" (Linux/Mac)  
```

At the play prompt, type:

eclipse

Then import the project into ScalaIDE.

Run the application with command 'run' and open browser to http://localhost:9000. Login with: 

```
simon@email.com
password
```

## Testing
### Karma/Jasmine testing
These are located under test/unit. Assuming you have got NodeJS installed, run with:

```
npm install -g grunt-cli
npm install
grunt karma:dist
```

### Play Controller Testing
These are located under test/controllers

UsersTest is probably the most complete. Use Mockito to mock out the injected interfaces and avoid having to access the db.

These tests are written with specs2 (https://www.playframework.com/documentation/2.3.x/ScalaTestingWithSpecs2)

### Integration Testing
DbUnit is typically used to test any SQL/DAO code. The available dataset formats provided by DbUnit are Excel and XML. 
Excel spreadsheet datasets have an issue with storing date-time values. The XML format is a bit verbose. JSON datasets
are a good choice [3].

However, DbUnit tests can be incredibly slow because it needs to figure out the truncate and insert order. The solution has 
been to include the insert order with the dataset and avoid this lengthly operation.

The implementation integration.dbunit.JSONDataSet.scala is based on [3] (converted to Scala and uses Play JSON API). The insert/truncate
order is stored in the file test/integration/insertSequence.json. This is generated by running integration.dbunit.GenerateDatabaseInsertOrder.scala.
 
All integration tests use the trait integration.dbunit.AbstractIntegrationTest.scala and setup the database before running the test e.g.

```
  var hasInitialisedDatabase = false
   
  before {
     if (!hasInitialisedDatabase) {
       setUpBeforeClass("test/integration/usersDataset.json")
       hasInitialisedDatabase = true
     }
  }
```       

### End to end Testing
These are located under test/e2e. 

AngularJS e2e testing is typically done using Protractor. However, e2e test with the Play application is required. 
Scalatest/Scalatest Plus provide a DSL which does this and it is the same as Protractor. Server side responses to test different cases
is implemented by mocking service traits and injected into the controllers. e2e testing also gives the controller methods an 
additional test coverage. 

Need to install Chrome driver: https://code.google.com/p/selenium/wiki/ChromeDriver

From the play prompt, compile using test:compile and run with test.

## Authorization
Based on Deadbolt and combined with XSRF handling code. See controllers/Security.scala for details and security package.

## Form Validation
Display a popover whenever there is an invalid field. See app/assets/javascripts/common/directives/validate.js for details and acknowledgments. 
The unit test UiValidateDirectiveSpec.js illustrates how to use the directive(s).  

## TODO
* Run karma tests as part of the build
* Code coverage reports
* Use LESS 

## References
[1] http://typesafe.com/activator/template/play-angular-require-seed

[2] https://github.com/juanignaciosl/wedding-tables-planner-web

[3] http://danhaywood.com/2011/12/20/db-unit-testing-with-dbunit-json-hsqldb-and-junit-rules/
